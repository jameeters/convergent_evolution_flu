---
title: "flu_selection"
output: html_document
date: "2026-01-22"
---
## Setup
```{r setup, include=FALSE}
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggrepel)
library(stringr)

theme_set(theme_bw())
setwd('/Users/james/Documents/convergent')
```

```{r read_files, include=F}
# HA data
mutations = read.csv('out/codon_mutation_counts_bovine_ha.tsv', sep='\t') %>% 
  mutate(host='bovine')
mutations = full_join(
  mutations,
  read.csv('out_avian_b3.13/codon_mutation_counts_ha.tsv', sep='\t') %>% 
    mutate(host='avian')
)
mutations = mutations %>% mutate(gene='HA')

# PB2 data
mutations = full_join(
  mutations,
  read.csv('out_bovine_b3.13_pb2/codon_mutation_counts.tsv', sep='\t') %>% 
    mutate(host='bovine', gene='PB2')
)
mutations = full_join(
  mutations,
  read.csv('out_avian_b3.13_pb2/codon_mutation_counts.tsv', sep='\t') %>% 
    mutate(host='avian', gene='PB2')
)

mutations = mutations %>% 
  group_by(pos_aa, ref_aa, alt_aa, host, gene) %>% 
  summarize(count = sum(count))

ha_site_numbering = read.csv('data/site_numbering_map_HA.csv')
```

### DMS data

#### Average value calculation

The DMS value calculation is slightly different than before, but it doesn't make much difference.
As before, we match DMS values with observed mutations by amino acid position, ref, and alt.
But instead of using a simple average across all values for a given position, 
we instead use a weighted average that favors the DMS values associated with mutations with more occurrences.

For example, if we have the following mutations:
```{r table1, echo=F}
print(data.frame(
  pos = c(10, '"'),
  ref = c('I', '"'),
  alt = c('M', 'V'),
  host = c('bovine', '"'),
  count = c(2, 1)
))
```
And the following DMS values for a given metric:
```{r table2, echo=F}
print(data.frame(
  pos = c(10, '"'),
  ref = c('I', '"'),
  alt = c('M', 'V'),
  value = c(0.2676, -2.3170)
))
```
Then we calculate our weighted average DMS value for bovine position 10 as:

```
sum(count * dms_value) / sum(count) 
= (2 * 0.2676 + 1 * -2.317) / 3 
= -0.593933
```
#### Read DMS data

todo: numbering for PB2 data

```{r read_dms, include=F}
dms_ha = read.csv('data/dms_data_ha.tsv', sep='\t') %>% 
  rename(
    pos_aa = position_aa,
    dms_name = name,
    dms_value = value,
  ) %>% 
  mutate(gene='HA') %>% 
  select(!c('ref_codon', 'alt_codon', 'gff_feature')) %>% 
  filter(!dms_name %in% c('evescape_sigmoid', 'evescape', 'mature_h5_site')) %>% 
  distinct()

# todo: numbering?
dms_pb2 = read.csv('data/summary_prefs_effects_diffsel.csv') %>% 
  select(c('site', 'wildtype', 'mutation', 'mutdiffsel')) %>% 
  rename(
    pos_aa = site,
    ref_aa = wildtype,
    alt_aa = mutation
  ) %>% 
  mutate(gene='PB2') %>% 
  pivot_longer(cols=mutdiffsel, names_to='dms_name', values_to='dms_value') %>% 
  filter(!is.na(dms_value))

dms = full_join(
  dms_ha,
  dms_pb2
)
  

# match dms to mutations by amino acid pos, ref, and alt.
# so dms values for mutations not seen in our data are not considered, even if 
# we see other mutations at the same position.
dms_by_mutation = 
  left_join(
    mutations, 
    dms, 
    by=c('pos_aa', 'ref_aa', 'alt_aa', 'gene'),
    relationship='many-to-many'
  )
  
# Weighted average of DMS values 
# only results in minor changes compared to naive average
dms_by_position = dms_by_mutation %>% 
  filter(!is.na(dms_name)) %>% 
  group_by(pos_aa, dms_name, host, gene) %>% 
  summarize(
    wt_mean_dms_value = sum(count * dms_value)/sum(count),
    mean_dms_value = mean(dms_value),
    min_dms_value = min(dms_value),
    max_dms_value = max(dms_value),
  )

```

#### Missing DMS Values

How many of our mutations do we have DMS data for?
This is counting by position, ref, and alt. 
```{r missing_dms_values, include=T, echo=F}
# count how many positons are missing values
wide_dms_by_mutation = dms_by_mutation %>% 
  select(!count) %>% 
  filter(alt_aa != ref_aa) %>% 
  pivot_wider(
    names_from=c(dms_name),
    values_from=dms_value,
    names_prefix='dms_'
  ) %>% 
  # shim is na for all, which lets us get the totals easily
  mutate(dms_shim_const_NA=NA)

calc_fracs_present = function(df){
  return(
    df %>%  
    mutate(across(starts_with('dms_'), ~ 1 - (.x/dms_shim_const_NA), .names='frac_present_{.col}')) %>%
    select(!(starts_with('dms_') | contains('NA'))) %>% 
    pivot_longer(names_to='dms_name', values_to='frac_present', cols=starts_with('frac_')) %>% 
    mutate(dms_name = str_remove(dms_name, 'frac_present_dms_')) 
    # pivot_wider(names_from = c(host), values_from=frac_present, names_prefix = 'frac_present_')
  )
}

dms_values_present_by_mutation = wide_dms_by_mutation %>% 
  group_by(host, gene) %>% 
  summarize(across(starts_with('dms_'), ~ sum(is.na(.x))), .groups='keep') %>% 
  calc_fracs_present()

ggplot(dms_values_present_by_mutation, aes(x=dms_name, y=frac_present)) +
  geom_col(aes(fill=interaction(host, gene)), position=position_dodge()) +
  theme(axis.text.x = element_text(angle = -30, vjust = 0.5, hjust=0))

dms_values_present_by_site = wide_dms_by_mutation %>%
  group_by(host, gene, pos_aa) %>%
  summarize(across(starts_with('dms_'), ~ mean(.x, na.rm=T))) %>%
  group_by(host, gene) %>%
  summarize(across(starts_with('dms_'), ~ sum(is.nan(.x)))) %>%
  calc_fracs_present()

```

### Calculate dN / dS

```{r calc_dn_ds, include=F}
dn_ds = mutations %>% 
  mutate(synonymous = (alt_aa == ref_aa)) %>% 
  group_by(pos_aa, host, gene, synonymous) %>% 
  summarize(n = sum(count)) %>% 
  pivot_wider(names_from=synonymous, values_from=n, values_fill=0) %>% 
  rename(count_n = 'FALSE', count_s = 'TRUE') %>% 
  mutate(
    ratio = case_when(
      count_s == 0 ~ count_n,
      .default = count_n / count_s
    ),
    zero_synonymous = (count_s == 0)
  )

dn_ds_dms = left_join(
  dms_by_position, 
  dn_ds, 
  by=c('pos_aa', 'host', 'gene')
)

dn_ds_dms_ha = dn_ds_dms %>% filter(gene == 'HA')
dn_ds_dms_pb2 = dn_ds_dms %>% filter(gene == 'PB2')

dn_ds_dms_by_mutation = left_join(
  dms_by_mutation,
  dn_ds,
  by=c('pos_aa', 'host', 'gene'),
  relationship='many-to-many'
) %>% 
  filter(! is.na(dms_name))

dn_ds_dms_by_mutation_ha = dn_ds_dms_by_mutation %>% filter(gene == 'HA')
dn_ds_dms_by_mutation_pb2 = dn_ds_dms_by_mutation %>% filter(gene == 'PB2')
```

## Plots

### dN / dS by position

```{r plot_by_pos, include=T, echo=F, fig.width=12, fig.height=9}
ggplot(dn_ds, aes(x=pos_aa, y=ratio)) +
  geom_hline(yintercept=1, linetype='dashed') +
  geom_point(aes(color=zero_synonymous)) +
  facet_wrap(vars(gene, host), ncol=1, labeller = label_wrap_gen(multi_line=FALSE)) +
  geom_text_repel(aes(label=ifelse(ratio>2.5,pos_aa,''))) +
  ggtitle('Selection, B3.13') +
  xlab('amino acid position') +
  ylab('dN/dS')
```

```{r praneeths_dn_ds_by_site, include=T, echo=F, warning=F, fig.width=12, fig.height=9}
dn_ds_ha = dn_ds %>% filter(gene == 'HA')
ggplot() +
  geom_rect(data=ha_site_numbering, aes(xmin=sequential_site-0.5, xmax=sequential_site+0.5, ymin=-Inf, ymax=Inf, fill=region), alpha=0.7) +
  scale_fill_manual(values=c('#77AADD', '#AAAA00', '#EE8866', '#99DDFF', '#EEDD88', '#FFAABB', '#44BB99', '#BBCC33')) +
  geom_hline(yintercept=1, linetype='dashed') +
  geom_point(data=dn_ds_ha, aes(x=pos_aa, y=ratio), fill='#0077bb', color='white', shape=21, size=3) +
  facet_wrap(~host, ncol=1) +
  geom_text_repel(data=dn_ds_ha, aes(x=pos_aa, y=ratio, label=ifelse(ratio>2.5,pos_aa,'')), max.overlaps=2) +
  ggtitle('Selection in HA, B3.13') +
  xlab('') +
  ylab('dN/dS Ratio') +
  scale_x_continuous(breaks=seq(0, 700, by=100)) +
  theme_classic()

```


### DMS comparison
#### HA

```{r plot_dms_comparison, include=T, echo=F, warning=F, fig.height=11, fig.width=11}
ggplot(dn_ds_dms_ha, aes(x=wt_mean_dms_value, y=ratio)) +
  geom_point(aes(color=zero_synonymous)) +
  ggtitle('HA, B3.13') +
  ylab('dN/dS') +
  facet_wrap(vars(dms_name, host), scales='free_x', ncol=4) +
  geom_text_repel(aes(label=pos_aa), max.overlaps=5, size=4)
```

Error bars show the range of DMS values associated with each point.
```{r plot_dms_comparison_error_bars, include=T, echo=F, warning=F, fig.height=11, fig.width=11}
ggplot(dn_ds_dms_ha, aes(x=wt_mean_dms_value, y=ratio, color=pos_aa)) +
  geom_point() +
  scale_color_continuous(type='viridis') + 
  geom_errorbarh(aes(xmin=min_dms_value, xmax=max_dms_value), height=0.5) +
  ggtitle('HA, B3.13') +
  ylab('dN/dS') +
  facet_wrap(vars(dms_name, host), scales='free_x', ncol=4) +
  geom_text_repel(aes(label=pos_aa), color='black', max.overlaps=5, size=4)
```

Plot with one point per observed mutation:
```{r plot_dms_comparison_ha_by_mutation, include=T, echo=F, warning=F, fig.height=11, fig.width=11}
ggplot(dn_ds_dms_by_mutation_ha, aes(x=dms_value, y=ratio)) +
  geom_point(aes(color=zero_synonymous)) +
  ggtitle('HA, B3.13') +
  ylab('dN/dS') +
  facet_wrap(vars(dms_name, host), scales='free_x', ncol=4) +
  geom_text_repel(aes(label=pos_aa), max.overlaps=5, size=4)
 
```

```{r plot_dms_comparison_ha_by_mutation_count, include=T, echo=F, warning=F, fig.height=11, fig.width=11}
ggplot(dn_ds_dms_by_mutation_ha, aes(x=dms_value, y=ratio)) +
  geom_point(aes(color=count)) +
  scale_color_continuous(type='viridis') +
  ggtitle('HA, B3.13') +
  ylab('dN/dS') +
  facet_wrap(vars(dms_name, host), scales='free_x', ncol=4) +
  geom_text_repel(aes(label=pos_aa), max.overlaps=5, size=4)
```

#### PB2
```{r plot_dms_comparison_pb2, include=T, echo=F, warning=F, fig.height=5, fig.width=11}
ggplot(dn_ds_dms_pb2, aes(x=wt_mean_dms_value, y=ratio)) +
  geom_point(aes(color=zero_synonymous)) +
  ggtitle('PB2, B3.13') +
  ylab('dN/dS') +
  facet_wrap(vars(dms_name, host), scales='free_x', ncol=4) +
  geom_text_repel(aes(label=pos_aa), max.overlaps=5, size=4)
```

```{r plot_dms_comparison_pb2_error_bars, include=T, echo=F, warning=F, fig.height=5, fig.width=11}
ggplot(dn_ds_dms_pb2, aes(x=wt_mean_dms_value, y=ratio, color=pos_aa)) +
  geom_point() +
  scale_color_continuous(type='viridis') + 
  geom_errorbarh(aes(xmin=min_dms_value, xmax=max_dms_value), height=0.15) +
  ggtitle('PB2, B3.13') +
  ylab('dN/dS') +
  facet_wrap(vars(dms_name, host), scales='free_x', ncol=4) +
  geom_text_repel(aes(label=pos_aa), color='black', max.overlaps=5, size=4)
```

By mutation:
```{r plot_dms_comparison_pb2_by_mutation, include=T, echo=F, warning=F, fig.height=5, fig.width=11}
ggplot(dn_ds_dms_by_mutation_pb2, aes(x=dms_value, y=ratio)) +
  geom_point(aes(color=zero_synonymous)) +
  ggtitle('PB2, B3.13') +
  ylab('dN/dS') +
  facet_wrap(vars(dms_name, host), scales='free_x', ncol=4) +
  geom_text_repel(aes(label=pos_aa), max.overlaps=5, size=4)
```

```{r plot_dms_comparison_pb2_by_mutation_count, include=T, echo=F, warning=F, fig.height=5, fig.width=11}
ggplot(dn_ds_dms_by_mutation_pb2, aes(x=dms_value, y=ratio)) +
  geom_point(aes(color=count)) +
  scale_color_continuous(type='viridis') +
  ggtitle('PB2, B3.13') +
  ylab('dN/dS') +
  facet_wrap(vars(dms_name, host), scales='free_x', ncol=4) +
  geom_text_repel(aes(label=pos_aa), max.overlaps=5, size=4)
```